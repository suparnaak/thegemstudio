<%- include("../../views/partials/admin/header") %>

<div class="container-fluid">
  <div class="row">
    <div class="col-lg-10 col-md-9 ml-sm-auto p-4">
      <h1>Product Management</h1>
      <a href="/admin/products/add" class="btn btn-primary mb-3">Add New Product</a>

      <div class="row mb-3">
        <div class="col-md-6">
          <form action="/admin/products" method="get">
            <input type="search" name="search" class="form-control" placeholder="Search products..."
              value="<%= search %>" id="search-input">
            <br>
            <button type="submit" class="btn btn-primary">Search</button>
          </form>
        </div>
      </div>

      <table class="table table-bordered">
        <thead class="thead-dark">
          <tr>
            <th>Product Image</th>
            <th>Product Name</th>
            <th>Brand</th>
            <th>Category</th>
            <th>Price</th>
            <th>Discount (%)</th>
            <th>Quantity</th>
            <th>Stock Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% products.forEach(product => { %>
            <tr id="row-<%= product._id %>">
              <td>
                <% if (product.images && product.images.length > 0) { %>
                  <img src="<%= product.images[0] %>" alt="<%= product.name %>" title="<%= product.name %>" style="max-width: 100px;" />
                <% } else { %>
                  <p>No image available</p>
                <% } %>
              </td>
              <td><%= product.name %></td>
              <td><%= product.brand.brandName %></td>
              <td><%= product.category ? product.category.name : 'Uncategorized' %></td>
              <td>â‚¹<%= product.price.toFixed(2) %></td>
              <td><%= product.discount %></td>
              <td><%= product.quantity %></td>
              <td class="status-text"><%= product.status %></td>
              <td>
                <a href="/admin/products/edit/<%= product._id %>" class="btn btn-warning btn-sm">Edit</a>
                <button type="button" 
                  class="btn <%= product.isListed ? 'btn-danger block-button' : 'btn-success unblock-button' %> btn-sm action-button" 
                  data-id="<%= product._id %>">
                  <%= product.isListed ? 'Block' : 'Unblock' %>
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Pagination -->
      <nav aria-label="Page navigation" class="d-flex justify-content-center">
        <ul class="pagination">
          <% if (currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&search=<%= search %>">Previous</a>
            </li>
          <% } %>
          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
            </li>
          <% } %>
          <% if (currentPage < totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="?page=<%= currentPage + 1 %>&search=<%= search %>">Next</a>
            </li>
          <% } %>
        </ul>
      </nav>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function bindActionButton(button) {
    const productId = button.getAttribute('data-id');
    const isBlock = button.classList.contains('block-button');
    const action = isBlock ? 'block' : 'unblock';
    const oppositeAction = isBlock ? 'unblock' : 'block';

    button.addEventListener('click', function () {
      Swal.fire({
        title: `Are you sure?`,
        text: `You want to ${action} this product!`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: isBlock ? '#d33' : '#28a745',
        cancelButtonColor: '#3085d6',
        confirmButtonText: `Yes, ${action} it!`
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/admin/products/${action}/${productId}`, {
            method: 'PATCH'
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              Swal.fire(`${action.charAt(0).toUpperCase() + action.slice(1)}ed!`, data.message, 'success');

              button.classList.toggle('btn-danger');
              button.classList.toggle('btn-success');
              button.classList.toggle('block-button');
              button.classList.toggle('unblock-button');
              button.textContent = isBlock ? 'Unblock' : 'Block';

              const row = document.getElementById(`row-${productId}`);
              if (row) {
                const statusCell = row.querySelector('.status-text');
                if (statusCell && row) {
                  const qty = parseInt(row.cells[6].textContent);
                  statusCell.textContent = qty === 0 ? "Out of Stock" : "Available";
                }
              }

              bindActionButton(button);
            } else {
              Swal.fire('Error!', data.message, 'error');
            }
          })
          .catch(error => {
            console.error(error);
            Swal.fire('Error!', 'Something went wrong!', 'error');
          });
        }
      });
    });
  }

  document.querySelectorAll('.action-button').forEach(button => {
    bindActionButton(button);
  });

  const searchInput = document.getElementById('search-input');
  searchInput.addEventListener('input', function () {
    if (this.value === '') {
      window.location.href = '/admin/products';
    }
  });
</script>

<%- include("../../views/partials/admin/footer") %>
