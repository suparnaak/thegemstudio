<%- include("../../views/partials/admin/header") %>
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-10 col-md-9 ml-sm-auto p-4">
      <h1>Add Product</h1>
      <form id="add-product-form" action="/admin/products/add" method="POST" enctype="multipart/form-data" novalidate>
        <div class="form-group">
          <label for="name">Product Name</label>
          <input type="text" class="form-control" id="name" name="name" />
          <small class="text-danger" id="name-error"></small>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea class="form-control" id="description" name="description" rows="3"></textarea>
          <small class="text-danger" id="description-error"></small>
        </div>

        <div class="form-group">
          <label for="brand">Brand</label>
          <select class="form-control" id="brand" name="brand">
            <option value="">Select Brand</option>
            <% brands.forEach(brand => { %>
              <option value="<%= brand._id %>"><%= brand.brandName %></option>
            <% }); %>
          </select>
          <small class="text-danger" id="brand-error"></small>
        </div>

        <div class="form-group">
          <label for="category">Category</label>
          <select class="form-control" id="category" name="category">
            <option value="">Select Category</option>
            <% categories.forEach(category => { %>
              <option value="<%= category._id %>"><%= category.name %></option>
            <% }); %>
          </select>
          <small class="text-danger" id="category-error"></small>
        </div>

        <div class="form-group">
          <label for="price">Price</label>
          <input type="number" class="form-control" id="price" name="price" min="0" value="0" />
          <small class="text-danger" id="price-error"></small>
        </div>

        <div class="form-group">
          <label for="discount">Discount (%)</label>
          <input type="number" class="form-control" id="discount" name="discount" value="0" min="0" max="90" />
          <small class="text-danger" id="discount-error"></small>
        </div>

        <div class="form-group">
          <label for="quantity">Quantity</label>
          <input type="number" class="form-control" id="quantity" name="quantity" value="0" min="0" />
          <small class="text-danger" id="quantity-error"></small>
        </div>

        <div class="form-group">
          <label for="color">Color</label>
          <input type="text" class="form-control" id="color" name="color" />
          <small class="text-danger" id="color-error"></small>
        </div>

        <div class="form-group">
          <label for="material">Material</label>
          <input type="text" class="form-control" id="material" name="material" />
          <small class="text-danger" id="material-error"></small>
        </div>

        <div class="form-group">
          <label for="images">Upload New Images (min 3)</label>
          <input type="file" class="form-control" id="images" name="images" multiple accept="image/*" />
          <small class="text-danger" id="images-error"></small>
        </div>

        <div id="imagePreviewContainer" class="d-flex flex-wrap mb-3"></div>

        <button type="submit" class="btn btn-success">Add Product</button>
        <br><br>
      </form>
    </div>
  </div>
</div>

<!-- Cropping Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" role="dialog" aria-labelledby="cropModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cropModalLabel">Crop Image</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="img-container">
          <img id="cropImage" src="" alt="Picture to crop">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="cropButton">Crop</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
  const form = document.getElementById('add-product-form');
  const nameInput = document.getElementById('name');
  const descriptionInput = document.getElementById('description');
  const brandInput = document.getElementById('brand');
  const categoryInput = document.getElementById('category');
  const priceInput = document.getElementById('price');
  const discountInput = document.getElementById('discount');
  const quantityInput = document.getElementById('quantity');
  const colorInput = document.getElementById('color');
  const materialInput = document.getElementById('material');
  const fileInput = document.getElementById('images');
  const imagePreviewContainer = document.getElementById('imagePreviewContainer');

  const nameError = document.getElementById('name-error');
  const descriptionError = document.getElementById('description-error');
  const brandError = document.getElementById('brand-error');
  const categoryError = document.getElementById('category-error');
  const priceError = document.getElementById('price-error');
  const discountError = document.getElementById('discount-error');
  const quantityError = document.getElementById('quantity-error');
  const colorError = document.getElementById('color-error');
  const materialError = document.getElementById('material-error');
  const imagesError = document.getElementById('images-error');

  let cropper;
  let currentImageIndex;
  const croppedImages = new Map();
  const originalImages = new Map();

  const isEmptyOrSpaces = (str) => !str || str.trim().length === 0;
  const hasOnlyLettersSpacesHyphens = (str) => /^[a-zA-Z\s\-]+$/.test(str.trim());

  // Validation functions
  function validateName() {
    if (isEmptyOrSpaces(nameInput.value)) {
      nameError.textContent = 'Product name is required.';
      nameInput.classList.add('is-invalid');
      return false;
    }
    nameError.textContent = '';
    nameInput.classList.remove('is-invalid');
    return true;
  }

  function validateDescription() {
    if (isEmptyOrSpaces(descriptionInput.value)) {
      descriptionError.textContent = 'Product description is required.';
      descriptionInput.classList.add('is-invalid');
      return false;
    }
    descriptionError.textContent = '';
    descriptionInput.classList.remove('is-invalid');
    return true;
  }

  function validateBrand() {
    if (isEmptyOrSpaces(brandInput.value)) {
      brandError.textContent = 'Please select a brand.';
      brandInput.classList.add('is-invalid');
      return false;
    }
    brandError.textContent = '';
    brandInput.classList.remove('is-invalid');
    return true;
  }

  function validateCategory() {
    if (isEmptyOrSpaces(categoryInput.value)) {
      categoryError.textContent = 'Please select a category.';
      categoryInput.classList.add('is-invalid');
      return false;
    }
    categoryError.textContent = '';
    categoryInput.classList.remove('is-invalid');
    return true;
  }

  function validatePrice() {
    const value = priceInput.value.trim();
    if (isEmptyOrSpaces(value) || parseFloat(value) <= 0) {
      priceError.textContent = 'Price must be greater than 0.';
      priceInput.classList.add('is-invalid');
      return false;
    }
    priceError.textContent = '';
    priceInput.classList.remove('is-invalid');
    return true;
  }

  function validateDiscount() {
    const value = discountInput.value.trim();
    if (isEmptyOrSpaces(value)) {
      discountError.textContent = 'Discount is required.';
      discountInput.classList.add('is-invalid');
      return false;
    }
    const discount = parseFloat(value);
    if (discount < 0 || discount > 90) {
      discountError.textContent = 'Discount must be between 0 and 90%.';
      discountInput.classList.add('is-invalid');
      return false;
    }
    discountError.textContent = '';
    discountInput.classList.remove('is-invalid');
    return true;
  }

  function validateQuantity() {
    const value = quantityInput.value.trim();
    if (isEmptyOrSpaces(value) || parseFloat(value) < 0) {
      quantityError.textContent = 'Quantity must be 0 or greater.';
      quantityInput.classList.add('is-invalid');
      return false;
    }
    quantityError.textContent = '';
    quantityInput.classList.remove('is-invalid');
    return true;
  }

  function validateColor() {
    const value = colorInput.value.trim();
    if (isEmptyOrSpaces(value)) {
      colorError.textContent = 'Color is required.';
      colorInput.classList.add('is-invalid');
      return false;
    }
    if (!hasOnlyLettersSpacesHyphens(value)) {
      colorError.textContent = 'Color can only contain letters, spaces, and hyphens.';
      colorInput.classList.add('is-invalid');
      return false;
    }
    colorError.textContent = '';
    colorInput.classList.remove('is-invalid');
    return true;
  }

  function validateMaterial() {
    const value = materialInput.value.trim();
    if (isEmptyOrSpaces(value)) {
      materialError.textContent = 'Material is required.';
      materialInput.classList.add('is-invalid');
      return false;
    }
    if (!hasOnlyLettersSpacesHyphens(value)) {
      materialError.textContent = 'Material can only contain letters, spaces, and hyphens.';
      materialInput.classList.add('is-invalid');
      return false;
    }
    materialError.textContent = '';
    materialInput.classList.remove('is-invalid');
    return true;
  }

  function validateImages() {
    const files = fileInput.files;
    if (files.length < 3) {
      imagesError.textContent = 'You must upload at least 3 images.';
      fileInput.classList.add('is-invalid');
      return false;
    }
    imagesError.textContent = '';
    fileInput.classList.remove('is-invalid');
    return true;
  }

  nameInput.addEventListener('blur', validateName);
  nameInput.addEventListener('input', () => {
    if (nameInput.value.trim().length > 0) {
      nameError.textContent = '';
      nameInput.classList.remove('is-invalid');
    }
  });

  descriptionInput.addEventListener('blur', validateDescription);
  descriptionInput.addEventListener('input', () => {
    if (descriptionInput.value.trim().length > 0) {
      descriptionError.textContent = '';
      descriptionInput.classList.remove('is-invalid');
    }
  });

  brandInput.addEventListener('blur', validateBrand);
  brandInput.addEventListener('change', validateBrand);

  categoryInput.addEventListener('blur', validateCategory);
  categoryInput.addEventListener('change', validateCategory);

  priceInput.addEventListener('blur', validatePrice);
  priceInput.addEventListener('input', () => {
    if (priceInput.value.trim().length > 0) {
      priceError.textContent = '';
      priceInput.classList.remove('is-invalid');
    }
  });

  discountInput.addEventListener('blur', validateDiscount);
  discountInput.addEventListener('input', () => {
    if (discountInput.value.trim().length > 0) {
      discountError.textContent = '';
      discountInput.classList.remove('is-invalid');
    }
  });

  quantityInput.addEventListener('blur', validateQuantity);
  quantityInput.addEventListener('input', () => {
    if (quantityInput.value.trim().length > 0) {
      quantityError.textContent = '';
      quantityInput.classList.remove('is-invalid');
    }
  });

  colorInput.addEventListener('blur', validateColor);
  colorInput.addEventListener('input', validateColor);

  materialInput.addEventListener('blur', validateMaterial);
  materialInput.addEventListener('input', validateMaterial);

  fileInput.addEventListener('change', function(e) {
    const files = e.target.files;
    if (files.length < 3) {
      Swal.fire({
        icon: 'warning',
        title: 'Insufficient Images',
        text: 'Please select at least 3 images',
        confirmButtonColor: '#3085d6',
        confirmButtonText: 'OK'
      });
      validateImages();
      return;
    }
    validateImages();
    previewImages(files);
  });

  // images
  function previewImages(files) {
    imagePreviewContainer.innerHTML = '';
    
    Array.from(files).forEach((file, index) => {
      const reader = new FileReader();
      
      reader.onload = function(e) {
        originalImages.set(index, file);
        
        const previewWrapper = document.createElement('div');
        previewWrapper.className = 'position-relative m-2';
        
        const preview = document.createElement('img');
        preview.src = e.target.result;
        preview.style.width = '150px';
        preview.style.height = '150px';
        preview.style.objectFit = 'cover';
        preview.style.cursor = 'pointer';
        preview.className = 'border rounded';
        preview.setAttribute('data-index', index);
        
        const cropBtn = document.createElement('button');
        cropBtn.className = 'btn btn-sm btn-primary mt-1 d-block w-100';
        cropBtn.textContent = 'Crop Image';
        cropBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          openCropModal(e.target.previousElementSibling.src, index);
        });
        
        previewWrapper.appendChild(preview);
        previewWrapper.appendChild(cropBtn);
        imagePreviewContainer.appendChild(previewWrapper);
      };
      
      reader.readAsDataURL(file);
    });
  }

  function openCropModal(imageSrc, index) {
    currentImageIndex = index;
    
    const cropImage = document.getElementById('cropImage');
    cropImage.src = imageSrc;
    
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    
    $('#cropModal').modal({
      backdrop: 'static',
      keyboard: false,
      show: true
    });
    
    $('#cropModal').on('shown.bs.modal', function() {
      cropper = new Cropper(cropImage, {
        aspectRatio: 1,
        viewMode: 2,
        dragMode: 'move',
        autoCropArea: 0.8,
        restore: false,
        guides: true,
        center: true,
        highlight: false,
        cropBoxMovable: true,
        cropBoxResizable: true,
        toggleDragModeOnDblclick: false,
        ready: function() {
          window.setTimeout(function() {
            cropper.resize();
          }, 200);
        }
      });
    });
  }

  document.getElementById('cropButton').addEventListener('click', function() {
    if (!cropper) return;

    const canvas = cropper.getCroppedCanvas({
      width: 800,
      height: 800,
      imageSmoothingQuality: 'high'
    });

    canvas.toBlob(function(blob) {
      croppedImages.set(currentImageIndex, blob);
      
      const preview = imagePreviewContainer.querySelector(`img[data-index="${currentImageIndex}"]`);
      preview.src = canvas.toDataURL();
      
      $('#cropModal').modal('hide');
    }, 'image/jpeg', 0.8);
  });

  $('#cropModal').on('hidden.bs.modal', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    $(this).off('shown.bs.modal');
  });

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const isNameValid = validateName();
    const isDescriptionValid = validateDescription();
    const isBrandValid = validateBrand();
    const isCategoryValid = validateCategory();
    const isPriceValid = validatePrice();
    const isDiscountValid = validateDiscount();
    const isQuantityValid = validateQuantity();
    const isColorValid = validateColor();
    const isMaterialValid = validateMaterial();
    const isImagesValid = validateImages();

    const isValid = isNameValid && isDescriptionValid && isBrandValid && 
                   isCategoryValid && isPriceValid && isDiscountValid && 
                   isQuantityValid && isColorValid && isMaterialValid && 
                   isImagesValid;

    if (!isValid) {
      return;
    }

    Swal.fire({
      title: 'Adding Product...',
      text: 'Please wait while we add your product',
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => {
        Swal.showLoading()
      }
    });

    const formData = new FormData(form);
    formData.delete('images');
    
    croppedImages.forEach((blob, index) => {
      formData.append('images', blob, `image-${index}.jpg`);
    });

    originalImages.forEach((file, index) => {
      if (!croppedImages.has(index)) {
        formData.append('images', file, `original-image-${index}.jpg`);
      }
    });

    try {
      const response = await fetch('/admin/products/add', {
        method: 'POST',
        body: formData
      });
      
      const result = await response.json();
      
      if (response.ok) {
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: 'Product added successfully!',
          confirmButtonColor: '#28a745',
          confirmButtonText: 'OK'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = '/admin/products';
          }
        });
      } else {
        throw new Error(result.message || 'Failed to add product');
      }
    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: error.message || 'Failed to add product. Please try again.',
        confirmButtonColor: '#d33',
        confirmButtonText: 'OK'
      });
    }
  });
</script>

<%- include("../../views/partials/admin/footer") %>