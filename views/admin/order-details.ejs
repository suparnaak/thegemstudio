<%- include("../partials/admin/header") %>
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-10 col-md-9 ml-sm-auto p-4">
                <h1>Order Details</h1>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Order ID: <%= order.orderId %>
                        </h5>
                        <p class="card-text">Customer: <%= order.userId.name %> (<%= order.userId.email %>)</p>
                        <p class="card-text">Order Date: <%= order.orderDate.toLocaleDateString() %>
                        </p>

                        <p class="card-text">
                            Payment Status:
                            <% if (order.paymentStatus==='Paid' ) { %>
                                <span class="badge badge-success">Paid</span>
                                <% } else { %>
                                    <span class="badge badge-warning">
                                        <%= order.paymentStatus %>
                                    </span>
                                    <button class="btn btn-success btn-sm ml-2" id="markAsPaid">Mark as Paid</button>
                                    <% } %>
                        </p>

                        <p class="card-text">Grand Total: ₹<%= order.grandTotal.toFixed(2) %>
                        </p>
<!--                         <p>Address:<%=order.address.name%>,
                            <%=order.address.houseName%>,
                            <%=order.address.city%>,
                            <%=order.address.street%>,
                            <%=order.address.country%>,
                            <%=order.address.zipcode%>,
                            <%=order.address.mobile%>,
                        </p> -->
                    </div>
                </div>

                <h2>Products</h2>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                            <th>Delivery Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% order.items.forEach((item, index)=> { %>
                            <tr>
                                <td>
                                    <%= item.productId.name %>
                                </td>
                                <td>₹<%= item.price.toFixed(2) %>
                                </td>
                                <td>
                                    <%= item.quantity %>
                                </td>
                                <td>₹<%= item.subtotal.toFixed(2) %>
                                </td>
                                <td>
                                    <%= item.deliveryStatus %>
                                </td>
                                <td>
                                    <% if (item.deliveryStatus==='Pending' ) { %>
                                        <button class="btn btn-success btn-sm changeStatus"
                                            data-product-id="<%= item.productId._id %>" data-status="Delivered">Mark as
                                            Delivered</button>
                                        <button class="btn btn-danger btn-sm changeStatus"
                                            data-product-id="<%= item.productId._id %>"
                                            data-status="Admin Cancelled">Cancel Order</button>
                                        <% } else if (item.deliveryStatus==='Return Pending' ) { %>
                                            <button class="btn btn-warning btn-sm changeStatus"
                                                data-product-id="<%= item.productId._id %>" data-status="Returned">Mark
                                                as Returned</button>
                                            <% } %>
                                </td>
                            </tr>
                            <% }); %>
                    </tbody>
                </table>
                <h2>Delivery Address</h2>
                <p>
                    <%= order.address.name %>, <%= order.address.houseName %>, <%= order.address.street %>, 
                    <%= order.address.city %>, <%= order.address.country %> - <%= order.address.zipcode %><br>
                    Mobile: <%= order.address.mobile %>
                </p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.getElementById('markAsPaid')?.addEventListener('click', function () {
            Swal.fire({
                title: 'Are you sure?',
                text: 'You are about to mark this order as paid.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, mark as paid'
            }).then((result) => {
                if (result.isConfirmed) {
                    updateStatus({
                        orderId: '<%= order._id %>',
                        paymentStatus: 'Paid'
                    });
                }
            });
        });
        document.querySelectorAll('.changeStatus').forEach(button => {
            button.addEventListener('click', function () {
                const newStatus = this.getAttribute('data-status');
                const productId = this.getAttribute('data-product-id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: `You are about to change the delivery status to ${newStatus}.`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, change it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        updateStatus({
                            orderId: '<%= order._id %>',
                            productId: productId,
                            newStatus: newStatus
                        });
                    }
                });
            });
        });

        function updateStatus(data) {
            fetch('/admin/update-order-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    Swal.fire('Updated!', data.message, 'success')
                        .then(() => {
                            location.reload();
                        });
                })
                .catch((error) => {
                    console.error('Error:', error);
                    Swal.fire('Error!', 'An error occurred while updating the status.', 'error');
                });
        }
    </script>

    <%- include("../partials/admin/footer") %>